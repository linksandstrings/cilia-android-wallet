package com.mrd.bitlib.model;

import com.mrd.bitlib.util.HexUtils;
import org.junit.Test;

import java.util.Arrays;
import java.util.List;

import static org.junit.Assert.*;

public class TransactionTest {
   private final String HEX_P2WPKH = "01000000000102fff7f7881a8099afa6940d42d1e7f6362bec38171ea3edf433541db4e4ad969f00000000494830450221008b9d1dc26ba6a9cb62127b02742fa9d754cd3bebf337f7a55d114c8e5cdd30be022040529b194ba3f9281a99f2b1c0a19c0489bc22ede944ccf4ecbab4cc618ef3ed01eeffffffef51e1b804cc89d182d279655c3aa89e815b1b309fe287d9b2b55d57b90ec68a0100000000ffffffff02202cb206000000001976a9148280b37df378db99f66f85c95a783a76ac7a6d5988ac9093510d000000001976a9143bde42dbee7e4dbe6a21b2d50ce2f0167faa815988ac000247304402203609e17b84f6a7d30c80bfa610b5b4542f32a8a0d5447a12fb1366d7f01cc44a0220573a954c4518331561406f90300e8f3358f51928d43c212a8caed02de67eebee0121025476c2e83188368da1ff3e292e7acafcdb3566bb0ad253f62fc70f07aeee635711000000";
   private final String HEX_P2SH_P2WPKH = "01000000000101db6b1b20aa0fd7b23880be2ecbd4a98130974cf4748fb66092ac4d3ceb1a5477010000001716001479091972186c449eb1ded22b78e40d009bdf0089feffffff02b8b4eb0b000000001976a914a457b684d7f0d539a46a45bbc043f35b59d0d96388ac0008af2f000000001976a914fd270b1ee6abcaea97fea7ad0402e8bd8ad6d77c88ac02473044022047ac8e878352d3ebbde1c94ce3a10d057c24175747116f8288e5d794d12d482f0220217f36a485cae903c713331d877c1f64677e3622ad4010726870540656fe9dcb012103ad1d8e89212f0b92c74d23bb710c00662ad1470198ac48c43f7d6f93a2a2687392040000";
   private final String HEX_P2WSH = "01000000000102e9b542c5176808107ff1df906f46bb1f2583b16112b95ee5380665ba7fcfc0010000000000ffffffff80e68831516392fcd100d186b3c2c7b95c80b53c77e77c35ba03a66b429a2a1b0000000000ffffffff0280969800000000001976a914de4b231626ef508c9a74a8517e6783c0546d6b2888ac80969800000000001976a9146648a8cd4531e1ec47f35916de8e259237294d1e88ac02483045022100f6a10b8604e6dc910194b79ccfc93e1bc0ec7c03453caaa8987f7d6c3413566002206216229ede9b4d6ec2d325be245c5b508ff0339bf1794078e20bfe0babc7ffe683270063ab68210392972e2eb617b2388771abe27235fd5ac44af8e61693261550447a4c3e39da98ac024730440220032521802a76ad7bf74d0e2c218b72cf0cbc867066e2e53db905ba37f130397e02207709e2188ed7f08f4c952d9d13986da504502b8c3be59617e043552f506c46ff83275163ab68210392972e2eb617b2388771abe27235fd5ac44af8e61693261550447a4c3e39da98ac00000000";
   private final String HEX_P2WSH2 = "0100000000010280e68831516392fcd100d186b3c2c7b95c80b53c77e77c35ba03a66b429a2a1b0000000000ffffffffe9b542c5176808107ff1df906f46bb1f2583b16112b95ee5380665ba7fcfc0010000000000ffffffff0280969800000000001976a9146648a8cd4531e1ec47f35916de8e259237294d1e88ac80969800000000001976a914de4b231626ef508c9a74a8517e6783c0546d6b2888ac024730440220032521802a76ad7bf74d0e2c218b72cf0cbc867066e2e53db905ba37f130397e02207709e2188ed7f08f4c952d9d13986da504502b8c3be59617e043552f506c46ff83275163ab68210392972e2eb617b2388771abe27235fd5ac44af8e61693261550447a4c3e39da98ac02483045022100f6a10b8604e6dc910194b79ccfc93e1bc0ec7c03453caaa8987f7d6c3413566002206216229ede9b4d6ec2d325be245c5b508ff0339bf1794078e20bfe0babc7ffe683270063ab68210392972e2eb617b2388771abe27235fd5ac44af8e61693261550447a4c3e39da98ac00000000";
   private final String HEX_P2SH_P2WSH = "0100000000010136641869ca081e70f394c6948e8af409e18b619df2ed74aa106c1ca29787b96e0100000023220020a16b5755f7f6f96dbd65f5f0d6ab9418b89af4b1f14a1bb8a09062c35f0dcb54ffffffff0200e9a435000000001976a914389ffce9cd9ae88dcc0631e88a821ffdbe9bfe2688acc0832f05000000001976a9147480a33f950689af511e6e84c138dbbd3c3ee41588ac080047304402206ac44d672dac41f9b00e28f4df20c52eeb087207e8d758d76d92c6fab3b73e2b0220367750dbbe19290069cba53d096f44530e4f98acaa594810388cf7409a1870ce01473044022068c7946a43232757cbdf9176f009a928e1cd9a1a8c212f15c1e11ac9f2925d9002205b75f937ff2f9f3c1246e547e54f62e027f64eefa2695578cc6432cdabce271502473044022059ebf56d98010a932cf8ecfec54c48e6139ed6adb0728c09cbe1e4fa0915302e022007cd986c8fa870ff5d2b3a89139c9fe7e499259875357e20fcbb15571c76795403483045022100fbefd94bd0a488d50b79102b5dad4ab6ced30c4069f1eaa69a4b5a763414067e02203156c6a5c9cf88f91265f5a942e96213afae16d83321c8b31bb342142a14d16381483045022100a5263ea0553ba89221984bd7f0b13613db16e7a70c549a86de0cc0444141a407022005c360ef0ae5a5d4f9f2f87a56c1546cc8268cab08c73501d6b3be2e1e1a8a08824730440220525406a1482936d5a21888260dc165497a90a15669636d8edca6b9fe490d309c022032af0c646a34a44d1f4576bf6a4a74b67940f8faa84c7df9abe12a01a11e2b4783cf56210307b8ae49ac90a048e9b53357a2354b3334e9c8bee813ecb98e99a7e07e8c3ba32103b28f0c28bfab54554ae8c658ac5c3e0ce6e79ad336331f78c428dd43eea8449b21034b8113d703413d57761b8b9781957b8c0ac1dfe69f492580ca4195f50376ba4a21033400f6afecb833092a9a21cfdf1ed1376e58c5d1f47de74683123987e967a8f42103a6d48b1131e94ba04d9737d61acdaa1322008af9602b3b14862c07a1789aac162102d8b661b0b3302ee2f162b09e07a55ad5dfbe673a9f01d9f0c19617681024306b56ae00000000";
   private final String HEX_NO_FIND_DELETE = "0100000000010169c12106097dc2e0526493ef67f21269fe888ef05c7a3a5dacab38e1ac8387f14c1d000000ffffffff01010000000000000000034830450220487fb382c4974de3f7d834c1b617fe15860828c7f96454490edd6d891556dcc9022100baf95feb48f845d5bfc9882eb6aeefa1bc3790e39f59eaa46ff7f15ae626c53e012102a9781d66b61fb5a7ef00ac5ad5bc6ffc78be7b44a566e3c87870e1079368df4c4aad4830450220487fb382c4974de3f7d834c1b617fe15860828c7f96454490edd6d891556dcc9022100baf95feb48f845d5bfc9882eb6aeefa1bc3790e39f59eaa46ff7f15ae626c53e0100000000";
   private final List<String> segwitTransactions = Arrays.asList(HEX_P2SH_P2WPKH, HEX_P2SH_P2WSH, HEX_P2WPKH, HEX_P2WSH, HEX_P2WSH2, HEX_NO_FIND_DELETE);

   @Test
   public void testSerialisation() throws Exception {
      for (String transactionHex : segwitTransactions) {
         BitcoinTransaction transaction = BitcoinTransaction.fromBytes(HexUtils.toBytes(transactionHex));
         assertEquals(transactionHex, HexUtils.toHex(transaction.toBytes()));
      }
   }

   @Test
   public void testIsRbf() throws Exception {
      // tx with sequence number maxint
      final BitcoinTransaction txSeqFFFFFFFF = BitcoinTransaction.fromBytes(HexUtils.toBytes("010000000190F55E38240AB795F7E11DF5E272D699B525C0E50AF69733FDA1B583C4273C23000000008A47304402206A945B64AE1478F1ED1374D3F1BD0B9DB66B424804EFB3CE59B38293A25F5CAF022037695FE1B04A07569E0F6C019AA406492294151F3A0E88CAE2C53ED713D5C6D50141048FD4539156A8AD9EF7E885CEAD013BF5377DE67E05AA34B662C6431F684C1D61D83B690FB8FEEEB69C305B4043F8D3DBB4F2847FEAF767E8EAC1E51E9C4425B2FFFFFFFF025E31920B000000001976A914152E9F6874A0768ADA32F1C8C5FC80337FD7EE5988AC00E1F505000000001976A914D3F9702528B302DBADCBBE26E91001C2E453814088ACB4270600"));
      assertFalse(txSeqFFFFFFFF.isRbfAble());

      // tx with sequence number maxint-1
      final BitcoinTransaction txSeqFEFFFFFF = BitcoinTransaction.fromBytes(HexUtils.toBytes("010000000190F55E38240AB795F7E11DF5E272D699B525C0E50AF69733FDA1B583C4273C23000000008A47304402206A945B64AE1478F1ED1374D3F1BD0B9DB66B424804EFB3CE59B38293A25F5CAF022037695FE1B04A07569E0F6C019AA406492294151F3A0E88CAE2C53ED713D5C6D50141048FD4539156A8AD9EF7E885CEAD013BF5377DE67E05AA34B662C6431F684C1D61D83B690FB8FEEEB69C305B4043F8D3DBB4F2847FEAF767E8EAC1E51E9C4425B2FEFFFFFF025E31920B000000001976A914152E9F6874A0768ADA32F1C8C5FC80337FD7EE5988AC00E1F505000000001976A914D3F9702528B302DBADCBBE26E91001C2E453814088ACB4270600"));
      assertFalse(txSeqFEFFFFFF.isRbfAble());

      // tx with sequence number maxint-2
      final BitcoinTransaction txSeqFDFFFFFF = BitcoinTransaction.fromBytes(HexUtils.toBytes("010000000190F55E38240AB795F7E11DF5E272D699B525C0E50AF69733FDA1B583C4273C23000000008A47304402206A945B64AE1478F1ED1374D3F1BD0B9DB66B424804EFB3CE59B38293A25F5CAF022037695FE1B04A07569E0F6C019AA406492294151F3A0E88CAE2C53ED713D5C6D50141048FD4539156A8AD9EF7E885CEAD013BF5377DE67E05AA34B662C6431F684C1D61D83B690FB8FEEEB69C305B4043F8D3DBB4F2847FEAF767E8EAC1E51E9C4425B2FDFFFFFF025E31920B000000001976A914152E9F6874A0768ADA32F1C8C5FC80337FD7EE5988AC00E1F505000000001976A914D3F9702528B302DBADCBBE26E91001C2E453814088ACB4270600"));
      assertTrue(txSeqFDFFFFFF.isRbfAble());
   }

   @Test
   public void testOpReturn() throws Exception {
      final BitcoinTransaction txOpReturn = BitcoinTransaction.fromBytes(HexUtils.toBytes("0100000002f8c106b44b3cf45946848a8d4b62f87813202ff9d4a320a00d24803edbebd8b700000000fdfd0000473044022011805e1400dbea6039c340eb4e19488432e7852c859ccb7be40e4f86e5671d0302205c561335fee1f336d975e87519b9dd5508035df7c63d6ce42d420d76b29f7c9d01483045022100f4eb9014aee7bcfb8fd9fb84ca61692a86a1a32bf80c91da8dde32d06aef131a022029f58d1831d03ceeda3918ad1be1fb531eff2082fd5a47b53f4b113077dc2f0e014c6952210315f2a4e2a1df0391dabfb605aca1e3c0d5b4ed7ad2857b752c26a656223a8fd021031e45f9ea24c00ccdba4ca386dc39473acfc8870ac55ca0b61dc88f201f1822382102f5af92ca47e95786b67d3787a05cafef65896a31555cc72b82ecdb7b0c43777d53aeffffffffaa553d7c79f15321ad55f9a5bbcfa9a2c24f5e09b4e173d27fd49419cbfdf49900000000fc00473044022070f68f0bcd177ca92e25942ef5cd66582d960e5145c4bd425da6d586e7050a14022022836890e3e25679e137c7370d2508a731d17ba89eefd1475f09387bbe7374ae014730440220647aedfcf96b4ceb278818c8632bfc36bbd6a899c166163ba34e2a007b41537d0220163620e2db8e559480dc4e6884b92a42c18e316b22376ac3c63a2ba393a179c3014c6952210315f2a4e2a1df0391dabfb605aca1e3c0d5b4ed7ad2857b752c26a656223a8fd021031e45f9ea24c00ccdba4ca386dc39473acfc8870ac55ca0b61dc88f201f1822382102f5af92ca47e95786b67d3787a05cafef65896a31555cc72b82ecdb7b0c43777d53aeffffffff03b80b00000000000017a914ff90cb7560f7351d59638f56d317e0896994eb91870000000000000000096a0743430215002014b80b00000000000017a914027ef0e2a14e64c697ac0b1680de04af59129e9a8700000000"));
      assertTrue(txOpReturn.outputs[1].script instanceof ScriptOutputOpReturn);

      ScriptOutputOpReturn script = (ScriptOutputOpReturn) txOpReturn.outputs[1].script;
      assertEquals(HexUtils.toHex(script.getDataBytes()),"43430215002014");

   }
}